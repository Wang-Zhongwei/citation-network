{% extends "base.html" %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'paper/css/result-page.css'%}">
{% endblock %}

{% block content %}
<div class="results">
  {% for paper in papers.data %}
  <div class="paper" style="display: flex; justify-content: space-between;" paper-id="{{ paper.paperId }}">
    <div class="paper-left">
      <h2>
        <a href="{{ paper.url }}">
          {{ paper.title }}
        </a>
      </h2>
      <div class="authors">
        {% for author in paper.authors %}
        {{ author.name }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      </div>
      <div class="publication-venue">
        <a href="{{paper.publicationVenue.url}}">

          {{ paper.publicationVenue.name }}
        </a>
      </div>
      {% if user.is_authenticated %}
      <!-- TODO: display filled bookmark if the paper is in library, optimize the backend so don't have to save the same
      paper twice -->
      <div class="paper-options-container">
        <div class="types">
          {% for type in paper.publicationTypes %}
          <span class="type-tag">
            {% if type == 'JournalArticle' %}
            Journal
            {% else %}
            {{ type }}
            {% endif %}
          </span>
          {% endfor %}
        </div>
        <div class="function-icon-container">
          <!-- TODO: keep record of saving status: in process or canceled. Now if user click save twice it is equivalent to be canceled -->
          <i class="bi bi-bookmark" onclick="savePaper('{{ paper.paperId }}')"></i>
        </div>
      </div>
      {% endif %}
      <p class="abstract">
        {{ paper.abstract }}
      </p>
    </div>
    <div style="clear: both;"></div>

    <div class="paper-right">
      <div>
        <div class="local-network">Paper Specifics</div>
        <p>
          <i class="bi bi-calendar icon small"></i>
          Year: {{ paper.year }}
        </p>
        <p>
          <i class="bi bi-blockquote-left icon large"></i>
          References: {{ paper.referenceCount }}
        </p>
        <p>
          <i class="bi bi-quote icon"></i>
          Citations: {{ paper.citationCount }}
        </p>
        <p>
          <i class="bi bi-tags icon"></i>
          Fields of Study:
          {% for field in paper.fieldsOfStudy %}
          <span class="field-of-study">{{ field }} </span>
          {% endfor %}
        </p>
      </div>
      <div>
        <div class="divider"></div>
        <div class="local-network">Local Network Visualization</div>
        <form action="{% url 'paper:graph' %}" class="button">
          <input type="hidden" name="paperId" value="{{ paper.paperId }}">
          <div>
            <input type="radio" id="citation-graph" name="graphType" value="citations" checked>
            <label for="citation-graph" style="font-size: smaller;">Citation Graph</label>
          </div>
          <div>
            <input type="radio" id="reference-graph" name="graphType" value="references">
            <label for="reference-graph" style="font-size: smaller;">Reference Graph</label>
          </div>
          <div class="view-button-container">
            <button class="view-button" type="submit">View</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% empty %}
  <p>No papers found.</p>
  {% endfor %}
  {% include 'pagination.html' with page=page query=query total_pages=total_pages searchPaper=searchPaper%}
</div>
{% endblock %}

{% block js %}
<script>
  window.onload = function () {
    var colorMap = {
      a: "#990000",
      b: "#3770d2",
      c: "#009999",
      d: "#000025",
      e: "#998200",
      f: "#0e390e",
      g: "#4d4d4d",
      h: "#ff0381",
      i: "#10001c",
      j: "#e4d232",
      k: "#5fb2ce",
      l: "#009900",
      m: "#c358a3",
      n: "#00001a",
      o: "#1a1a00",
      p: "#c537d2",
      q: "#ff5a76",
      r: "#990000",
      s: "#8d8d8d",
      t: "#001a1a",
      u: "#1a001a",
      v: "#e228e2",
      w: "#e9b759",
      x: "#000000",
      y: "#999900",
      z: "#8affff"
    };

    var fields = document.getElementsByClassName('field-of-study');
    for (var i = 0; i < fields.length; i++) {
      var firstLetter = fields[i].innerText.charAt(0).toLowerCase();
      fields[i].style.backgroundColor = colorMap[firstLetter] ? colorMap[firstLetter] : '#808080';
    }
  }
</script>
<script>
  const libraryList = document.querySelector('.library-list');
  function toggleLibraryCheckBox() {
    libraryList.querySelectorAll('input').forEach(input => {
      input.checked = false;
      input.toggleAttribute('hidden');
    });
    // display the confirm button
    libraryList.querySelector('.libraries-confirm-button').toggleAttribute('hidden');
  }

  function showSidebar() {
    // toggle the sidebar if closed
    const body = document.querySelector('body');
    if (body.classList.contains('sidebar-closed')) {
      body.classList.remove('sidebar-closed');
    }
    // display the library list if not shown
    const libraryContainer = document.querySelector('#library-links-container');
    if (!libraryContainer.classList.contains('show')) {
      libraryContainer.classList.add('show');
    }
  }

  function confirmBtnOnClick(paperId) {
    const ids = [];
    libraryList.querySelectorAll('input').forEach(input => {
      if (input.checked) {
        ids.push(input.value);
      }
    });
    libraryList.querySelectorAll('input').forEach(input => {
      if (input.checked) {
        fetch(`/api/libraries/${input.value}/papers/`, {
          method: 'POST',
          body: JSON.stringify({ ids: [paperId] }),
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken }
        }).catch(err => {
          console.log(err);
          alert('Error saving paper!');
        });
      }
    });
    toggleLibraryCheckBox();
    alert('Paper saved!')
  }

  function savePaper(paperId) {
    showSidebar();
    toggleLibraryCheckBox();
    if (confirm('Save this paper to your libraries?')) {
      const confirmButton = libraryList.querySelector('.libraries-confirm-button');
      confirmButton.addEventListener('click', () => confirmBtnOnClick(paperId));
    }
  }
</script>
{% endblock %}